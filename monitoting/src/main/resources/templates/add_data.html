<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{fragments/layout :: layout(
        ~{::main},
        'Add Data - Green Portal',
        'add',
        'Add Data',
        'Admin entry'
      )}">

<main class="page-shell">

    <style>

        .card-soft{
            border: 1px solid rgba(15,81,50,.12);
            border-radius: 20px;
            box-shadow: 0 16px 44px rgba(0,0,0,.08);
            background:#fff;
            padding: 18px;
            width: 100%;
        }

        /* chips */
        .chips{
            display:flex;
            flex-wrap:wrap;
            gap:10px;
            margin-bottom: 14px;
        }
        .chip{
            border: 1px solid #e5efe9;
            background: #fff;
            border-radius: 999px;
            padding: .55rem .95rem;
            font-size: .95rem;
            cursor:pointer;
            transition: .15s ease;
            user-select:none;
            display:inline-flex;
            align-items:center;
            gap:.5rem;
        }
        .chip i{ color:#198754; }
        .chip:hover{ transform: translateY(-1px); box-shadow: 0 10px 20px rgba(0,0,0,.06); }
        .chip.active{
            background: rgba(25,135,84,.12);
            border-color: rgba(25,135,84,.35);
            font-weight: 700;
        }

        /* Inputs */
        .form-label{ font-weight: 700; }
        .req{ color:#dc3545; margin-left: 4px; }

        .input-group .btn{
            border-radius: 12px;
        }
        .input-group .form-control{
            border-radius: 12px 0 0 12px;
        }
        .input-group .input-group-text{
            border-radius: 0;
            font-weight: 700;
            background: #f8fafc;
        }
        .input-group .btn:last-child{
            border-radius: 0 12px 12px 0;
        }

        .hint{ font-size:.88rem; color:#6b7280; margin-top:.35rem; }

        .actions{
            margin-top: 16px;
            padding-top: 14px;
            border-top: 1px solid #eef2ef;
            display:flex;
            gap:10px;
            flex-wrap:wrap;
            justify-content:center;
        }
        .btn-round{ border-radius: 14px; padding: 10px 16px; min-width: 160px; font-weight: 700; }

        .date-note{
            display:flex;
            align-items:center;
            gap:8px;
            color:#6b7280;
            font-size:.9rem;
            margin-top:6px;
        }
    </style>

    <div class="d-flex flex-wrap justify-content-between align-items-end gap-2 mb-3">
        <div>
        <h1 class="fw-bold mb-1 pt-2">Add Infrastructure Data</h1>
        <div class="text-muted">Quick admin entry with smart defaults</div>
        </div>
    </div>

    <!-- Server success message -->
    <div th:if="${success}" class="alert alert-success py-2 text-center mb-3">
        <i class="bi bi-check-circle me-1"></i>
        <b th:text="${success}"></b>
    </div>

    <div class="card-soft">

        <!-- Chips -->
        <div class="chips">
            <span class="chip" data-type="Water Usage"><i class="bi bi-droplet-fill"></i> Water</span>
            <span class="chip" data-type="Electricity Consumption"><i class="bi bi-lightning-fill"></i> Electricity</span>
            <span class="chip" data-type="Waste Collected"><i class="bi bi-trash-fill"></i> Waste</span>
            <span class="chip" data-type="Trees Planted"><i class="bi bi-tree-fill"></i> Trees</span>
        </div>

        <form action="/saveReport" method="post" id="addForm" novalidate>
            <div class="row g-3 align-items-end">

                <div class="col-lg-4 col-md-6">
                    <label class="form-label">Data Type <span class="req">*</span></label>
                    <select class="form-select" name="dataType" id="dataType" required>
                        <option value="" selected disabled>Select Type</option>
                        <option value="Trees Planted">ðŸŒ³ Trees Planted</option>
                        <option value="Water Usage">ðŸ’§ Water Usage</option>
                        <option value="Electricity Consumption">âš¡ Electricity Consumption</option>
                        <option value="Waste Collected">ðŸ—‘ Waste Collected</option>
                    </select>
                    <div class="invalid-feedback">Please select a data type.</div>
                </div>

                <div class="col-lg-4 col-md-6">
                    <label class="form-label">Location <span class="req">*</span></label>
                    <select class="form-select" name="location" id="location" required>
                        <option value="" selected disabled>Select Location</option>
                        <option value="Main Campus">Main Campus</option>
                        <option value="Admin Block">Admin Block</option>
                        <option value="Hostel">Hostel</option>
                        <option value="Campus Garden">Campus Garden</option>
                    </select>
                    <div class="invalid-feedback">Please select a location.</div>
                </div>

                <div class="col-lg-4 col-md-12">
                    <label class="form-label">Date <span class="req">*</span></label>
                    <input type="date" class="form-control" name="date" id="date" required />
                    <div class="invalid-feedback">Date is required.</div>
                </div>

                <div class="col-12">
                    <label class="form-label" id="valueLabel">Value <span class="req">*</span></label>

                    <div class="input-group">
                        <input type="number" class="form-control" name="value" id="value"
                               min="0" step="0.01" placeholder="Enter value" required />

                        <span class="input-group-text" id="unitBadge">â€”</span>

                        <button class="btn btn-outline-secondary" type="button" id="inc10">+10</button>
                        <button class="btn btn-outline-secondary" type="button" id="inc50">+50</button>
                    </div>

                    <div class="hint" id="valueHint">Select a type to auto-set the unit.</div>
                    <input type="hidden" name="unit" id="unit" />
                </div>

            </div>

            <div class="actions">
                <button type="submit" class="btn btn-success btn-round">
                    <i class="bi bi-save me-1"></i> Save
                </button>

                <button type="button" class="btn btn-outline-success btn-round" id="saveAndNewBtn">
                    <i class="bi bi-plus-circle me-1"></i> Save & New
                </button>

                <button type="reset" class="btn btn-outline-secondary btn-round" id="resetBtn">
                    <i class="bi bi-arrow-counterclockwise me-1"></i> Reset
                </button>

                <input type="hidden" name="saveAndNew" id="saveAndNew" value="false" />
            </div>
        </form>

    </div>

    <script>
        const form = document.getElementById('addForm');
        const dataTypeEl = document.getElementById('dataType');
        const locationEl = document.getElementById('location');
        const valueEl = document.getElementById('value');
        const unitHiddenEl = document.getElementById('unit');
        const unitBadgeEl = document.getElementById('unitBadge');
        const saveAndNewEl = document.getElementById('saveAndNew');
        const valueLabelEl = document.getElementById('valueLabel');
        const valueHintEl = document.getElementById('valueHint');
        const dateEl = document.getElementById('date');
        const resetBtn = document.getElementById('resetBtn');

        const chips = Array.from(document.querySelectorAll('.chip[data-type]'));

        const typeConfig = {
            "Water Usage": { unit: "Liters", step: "0.01", label: "Water Used", hint: "Enter total water used (Liters)." },
            "Electricity Consumption": { unit: "kWh", step: "0.01", label: "Electricity Used", hint: "Enter consumption (kWh)." },
            "Waste Collected": { unit: "Kg", step: "0.01", label: "Waste Collected", hint: "Enter waste collected (Kg)." },
            "Trees Planted": { unit: "Count", step: "1", label: "Trees Planted", hint: "Whole number only (Count)." }
        };

        function setTodayIfEmpty() {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            const iso = `${yyyy}-${mm}-${dd}`;

            if (!dateEl.value) dateEl.value = iso;

            // If you want date FIXED (cannot change), uncomment:
            // dateEl.readOnly = true;
            // dateEl.style.backgroundColor = "#f8fafc";
        }

        function setActiveChip(){
            chips.forEach(c => c.classList.remove('active'));
            const chip = chips.find(c => c.getAttribute('data-type') === dataTypeEl.value);
            if (chip) chip.classList.add('active');
        }

        function applyTypeConfig(){
            const cfg = typeConfig[dataTypeEl.value];
            if (!cfg) {
                unitHiddenEl.value = "";
                unitBadgeEl.textContent = "â€”";
                valueEl.step = "0.01";
                valueLabelEl.innerHTML = "Value <span class='req'>*</span>";
                valueHintEl.textContent = "Select a type to auto-set the unit.";
                setActiveChip();
                return;
            }
            unitHiddenEl.value = cfg.unit;
            unitBadgeEl.textContent = cfg.unit;
            valueEl.step = cfg.step;
            valueLabelEl.innerHTML = cfg.label + " <span class='req'>*</span>";
            valueHintEl.textContent = cfg.hint;
            setActiveChip();
        }

        function saveLastUsed(){
            const payload = { dataType: dataTypeEl.value, location: locationEl.value };
            localStorage.setItem("greenportal_last_fixed", JSON.stringify(payload));
        }

        function restoreLastUsed(){
            const last = JSON.parse(localStorage.getItem("greenportal_last_fixed") || "{}");
            if (last.dataType) dataTypeEl.value = last.dataType;
            if (last.location) locationEl.value = last.location;
            applyTypeConfig();
        }

        restoreLastUsed();
        setTodayIfEmpty();

        dataTypeEl.addEventListener('change', () => { applyTypeConfig(); saveLastUsed(); });
        locationEl.addEventListener('change', saveLastUsed);

        chips.forEach(chip => {
            chip.addEventListener('click', () => {
                dataTypeEl.value = chip.getAttribute('data-type');
                applyTypeConfig();
                saveLastUsed();
                valueEl.focus();
            });
        });

        document.getElementById('inc10').addEventListener('click', () => inc(10));
        document.getElementById('inc50').addEventListener('click', () => inc(50));

        function inc(amount){
            const cfg = typeConfig[dataTypeEl.value];
            const current = parseFloat(valueEl.value || "0");
            const next = current + amount;
            valueEl.value = (cfg && cfg.step === "1") ? Math.round(next) : next.toFixed(2);
            valueEl.focus();
        }

        document.getElementById('saveAndNewBtn').addEventListener('click', () => {
            saveAndNewEl.value = "true";
            form.requestSubmit();
        });

        resetBtn.addEventListener('click', () => {
            setTimeout(() => {
                setTodayIfEmpty();
                applyTypeConfig();
            }, 0);
        });

        form.addEventListener('submit', (e) => {
            setTodayIfEmpty();

            if (!form.checkValidity()) {
                e.preventDefault();
                e.stopPropagation();
                form.classList.add('was-validated');
                return;
            }
            const cfg = typeConfig[dataTypeEl.value];
            if (cfg && cfg.step === "1" && String(valueEl.value).includes('.')) {
                e.preventDefault();
                alert("Trees Planted must be a whole number (no decimals).");
                valueEl.focus();
            }
        });

        applyTypeConfig();
    </script>

</main>
</html>
